<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style type="text/css">
body, div, canvas, img {
  margin: 0;
  padding: 0;
}
#targetImage {
  display: none;
  position: absolute;
  left: 0;
  top: 0;
}
canvas {
  display: block;
}
#pictureCanvas, #selectCanvas, #downloadContainer {
  position: fixed;
}
#downloadContainer {
  visibility: hidden;
}
#downloadContainer .label {
  position: absolute;
  width: 500px;
  bottom: -25px;
  font-family: sans-serif;
  font-size: 17px;
  color: #444;
}
#selectCanvas {
  opacity: 0.5;
  cursor: default;
}
</style>
<script>
var CanvasRegionToImage = (function () {
  'use strict';

  var width = 400,
      height = 500,
      ants = {
        size: 3,
        speed: 50
      };

  // Returns a random RGB string (RGBA if alpha is true).
  function randomColor(alpha) {
    var rgb = [
      Math.floor(Math.random() * 255),
      Math.floor(Math.random() * 255),
      Math.floor(Math.random() * 255)
    ];
    if (alpha) {
      rgb.push(Math.random());
    }
    return 'rgb' + (alpha ? 'a' : '') + '(' + rgb.join(', ') + ')';
  }

  // Paints the given canvas with random circles and rectangles.
  function paintRandomPicture(canvas) {
    var context = canvas.getContext('2d'),
        width = canvas.width,
        height = canvas.height,
        i, x, y, r;
    context.fillStyle = randomColor();
    context.fillRect(0, 0, width, height);
    for (i = 0; i < 300; ++i) {
      x = Math.floor(Math.random() * width);
      y = Math.floor(Math.random() * height);
      r = Math.floor(width/9 + Math.random() * width/4);
      context.fillStyle = randomColor(true);
      context.save();
      context.translate(x, y);
      context.rotate(Math.random() * Math.PI);
      context.scale(1, 0.2 + 1.6*Math.random());
      if (Math.random() < 0.6) {
        context.fillRect(-r/2, -r/2, r/2, r/2);
      } else {
        context.beginPath();
        context.arc(0, 0, r/3, 0, 2 * Math.PI);
        context.fill();
        context.closePath();
      }
      context.restore();
    }
    return canvas;
  }

  function updateAnts(x, y, w, h) {
    var canvas = ants.canvas,
        context = ants.context;
    ants.circumference = 2*(w + h + 2);
    function animate() {
      var elapsed = Date.now() - ants.lapTime,
          s = Math.round(elapsed / ants.speed),
          c = ants.circumference,
          laps;
      if (s > c) {
        console.log('before', c, s, ants.lapTime);
        laps = Math.floor(s / c);
        s -= laps * c;
        ants.lapTime += laps * c * ants.speed;
        console.log('after', c, s, ants.lapTime);
      }
      console.log(s);
      context.clearRect(0, 0, canvas.width, canvas.height);
      if (!ants.running) {
        return;
      }
      context.fillStyle = '#fff';
      context.fillRect(x - 1, y - 1, w + 2, h + 2);
      context.clearRect(x, y, w, h);
      context.fillStyle = '#000';
      if (s < w + 1) {
        context.fillRect(x - 1 + s, y - 1, 1, 1);
      } else if (s < w + h + 2) {
        s -= w + 1;
        context.fillRect(x + w, y - 1 + s, 1, 1);
      } else if (s < 2*w + h + 3) {
        s -= w + h + 2;
        context.fillRect(x + w - s, y + h, 1, 1);
      } else {
        s -= 2*w + h + 3;
        context.fillRect(x - 1, y + h - s, 1, 1);
      }
      requestAnimationFrame(animate);
    }
    animate();
  }

  function startAnts(canvas) {
    ants.canvas = canvas;
    ants.context = canvas.getContext('2d');
    ants.lapTime = Date.now();
    ants.running = true;
  }

  function stopAnts() {
    ants.running = false;
  }

  function load() {
    var targetImage = document.getElementById('targetImage'),
        downloadContainer = document.getElementById('downloadContainer'),
        pictureCanvas = document.getElementById('pictureCanvas'),
        selectCanvas = document.getElementById('selectCanvas'),
        clipCanvas = document.createElement('canvas'),
        clipContext = clipCanvas.getContext('2d');
    downloadContainer.style.left = width + 25 + 'px';
    downloadContainer.appendChild(clipCanvas);
    pictureCanvas.width = selectCanvas.width = width;
    pictureCanvas.height = selectCanvas.height = height;
    paintRandomPicture(pictureCanvas);
    selectCanvas.onmousedown = function (event) {
      var x0 = Math.max(0, Math.min(event.clientX, width)),
          y0 = Math.max(0, Math.min(event.clientY, height));
      function mousemove(event) {
        var x = Math.max(0, Math.min(event.clientX, width)),
            y = Math.max(0, Math.min(event.clientY, height)),
            dx = x - x0, w = Math.abs(dx),
            dy = y - y0, h = Math.abs(dy);
        clipCanvas.width = w;
        clipCanvas.height = h;
        if (w*h == 0) {
          downloadContainer.style.visibility = 'hidden';
          return;
        }
        updateAnts(Math.min(x0, x), Math.min(y0, y), w, h);
        downloadContainer.style.visibility = 'visible';
        clipContext.drawImage(pictureCanvas,
          x0 + Math.min(0, dx), y0 + Math.min(0, dy), w, h,
          0, 0, w, h);
        downloadContainer.style.visibility = (w*h == 0 ? 'hidden' : 'visible');
        downloadContainer.style.top = Math.min(y0, y) + 'px';
      }
      function mouseup(event) {
        selectCanvas.onmousemove = undefined;
        document.onmouseup = undefined;
        targetImage.src = clipCanvas.toDataURL();
        targetImage.style.display = 'block';
        stopAnts();
      }
      selectCanvas.onmousemove = mousemove;
      document.onmouseup = mouseup;
      targetImage.style.display = 'none';
      startAnts(selectCanvas);
      mousemove(event);
    };
  }

  return {
    load: load
  };
})();

onload = CanvasRegionToImage.load;
</script>
</head>
<body>

<canvas id="pictureCanvas"></canvas>

<canvas id="selectCanvas"></canvas>

<div id="downloadContainer">
  <div class="label"> right-click above to download as an image </div>
  <img id="targetImage">
</div>

</body>
</html>
